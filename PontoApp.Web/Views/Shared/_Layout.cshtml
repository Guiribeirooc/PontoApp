@using System.Security.Claims
<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>@ViewData["Title"] - PontoApp</title>

	<link rel="manifest" href="/manifest.webmanifest" asp-append-version="true">
	<meta name="theme-color" content="#883778">
	<link rel="icon" href="/img/icon-192.png" asp-append-version="true">
	<link rel="apple-touch-icon" href="/img/icon-192.png" asp-append-version="true">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

	<style>
		:root {
			--easy-purple: #883778;
			--easy-purple-dark: #6d2d5d;
			--easy-cream: #f8f5e8;
		}

		html {
			font-size: 16px;
		}

		body {
			background-color: var(--easy-cream);
			font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
			font-weight: 400;
			color: #2d2d2d;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
			text-rendering: optimizeLegibility;
			letter-spacing: 0.2px;
		}

		h1, h2, h3, h4, h5, h6 {
			font-weight: 600;
			letter-spacing: -0.3px;
		}

		.dropdown-menu {
			border: 0;
			border-radius: 12px;
			box-shadow: 0 10px 30px rgba(0,0,0,.12);
		}

		.dropdown-item {
			padding: .55rem 1rem;
		}

			.dropdown-item.active, .dropdown-item:active {
				background-color: var(--easy-purple);
				color: #fff;
			}

		header, footer {
			background-color: var(--easy-purple);
			color: #fff;
			padding: 10px;
		}

		.brand {
			display: flex;
			align-items: center;
			gap: .6rem;
			color: #fff;
			text-decoration: none;
		}

			.brand:hover {
				text-decoration: none;
				opacity: .95;
			}

		.brand-img {
			width: 38px;
			height: 38px;
			border-radius: 50%;
			object-fit: cover;
			display: block;
		}

		.brand-title {
			margin: 0;
			font-size: 1.15rem;
			font-weight: 700;
		}

		.brand-sub {
			margin: 0;
			font-size: .8rem;
			font-weight: 500;
			opacity: .9;
			line-height: 1;
		}

		.btn-primary, .btn-secondary, .btn-info, .btn-outline-primary {
			background-color: var(--easy-purple) !important;
			border-color: var(--easy-purple) !important;
			color: #fff !important;
		}

			.btn-primary:hover, .btn-secondary:hover, .btn-info:hover, .btn-outline-primary:hover {
				background-color: var(--easy-purple-dark) !important;
				border-color: var(--easy-purple-dark) !important;
			}

		.nav-link, .btn-link {
			color: #fff !important;
			text-decoration: none;
		}

			.nav-link:hover, .btn-link:hover {
				text-decoration: underline;
			}

		.table td, .table th {
			vertical-align: middle;
		}

			.table td form {
				margin: 0;
			}

		.emp-photo-thumb {
			height: 40px;
			border-radius: 6px;
			cursor: zoom-in;
			transition: transform .08s ease-in-out;
		}

			.emp-photo-thumb:hover {
				transform: scale(1.04);
			}
	</style>

	@RenderSection("Head", required: false)
</head>
<body class="d-flex flex-column min-vh-100">
	@{
		var today = DateTime.Today;
		var ini = new DateOnly(today.Year, today.Month, 1);
		var fim = DateOnly.FromDateTime(today);
		var iniStr = ini.ToString("yyyy-MM-dd");
		var fimStr = fim.ToString("yyyy-MM-dd");
	}
	<header class="d-flex justify-content-between align-items-center px-4">
		<div class="d-flex align-items-center gap-3">
			<a class="brand" asp-controller="Home" asp-action="Index">
				<img class="brand-img" src="/img/easy-ponto-logo.png" alt="Easy Ponto" loading="lazy" />
				<div class="d-flex flex-column">
					<span class="brand-title">Easy Ponto</span>
					<span class="brand-sub">Gestão Simples de Ponto</span>
				</div>
			</a>
			<nav class="d-flex gap-3 align-items-center">
				@if (User.Identity?.IsAuthenticated ?? false)
				{
					var isAdmin = User.IsInRole("Admin") ||
					string.Equals(User.FindFirstValue(ClaimTypes.Role), "Admin", StringComparison.OrdinalIgnoreCase);

					if (isAdmin)
					{
						<a class="nav-link" asp-controller="Home" asp-action="Index">Home</a>

						<div class="dropdown">
							<a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
								<i class="bi bi-clock-history me-1"></i> Gestão de ponto
							</a>
							<ul class="dropdown-menu">
								<li><a class="dropdown-item" asp-controller="AdminPunch" asp-action="Create">Marcação Manual</a></li>
								<li><a class="dropdown-item" asp-controller="Punch" asp-action="Dia">Dia</a></li>
								<li><a class="dropdown-item" asp-controller="Punch" asp-action="Mes">Mês</a></li>
								<li><a class="dropdown-item" asp-controller="Report" asp-action="Periodo">Relatório por período</a></li>
								<li><hr class="dropdown-divider" /></li>
								<li><a class="dropdown-item" asp-controller="Report" asp-action="Timesheet">Espelho de ponto</a></li>
								<li>
									<a class="dropdown-item"
									   asp-controller="Report"
									   asp-action="TimesheetPdf"
									   asp-route-inicio="@iniStr"
									   asp-route-fim="@fimStr">
										Exportar Espelho (PDF)
									</a>
								</li>
							</ul>
						</div>

						<div class="dropdown">
							<a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
								<i class="bi bi-card-checklist me-1"></i> Cadastros
							</a>
							<ul class="dropdown-menu">
								<li><a class="dropdown-item" asp-controller="Employee" asp-action="Index">Colaboradores</a></li>
							</ul>
						</div>
					}
					else
					{
						<a class="nav-link" asp-controller="Punch" asp-action="Bater">Bater Ponto</a>
						<a class="nav-link" asp-controller="Punch" asp-action="Meu">Meu Ponto</a>
						<a class="nav-link" asp-controller="Report" asp-action="Timesheet">Espelho de ponto</a>
						<a class="nav-link"
						   asp-controller="Report"
						   asp-action="TimesheetPdf"
						   asp-route-inicio="@iniStr"
						   asp-route-fim="@fimStr">
							Meu Espelho (PDF)
						</a>
					}
				}
			</nav>
		</div>

		<div class="d-flex align-items-center gap-3">
			@if (User.Identity?.IsAuthenticated ?? false)
			{
				var isAdmin = User.IsInRole("Admin") ||
				string.Equals(User.FindFirstValue(ClaimTypes.Role), "Admin", StringComparison.OrdinalIgnoreCase);

				var displayName =
				User.FindFirstValue(ClaimTypes.Name)
				?? User.FindFirstValue(ClaimTypes.GivenName)
				?? User.FindFirstValue(ClaimTypes.Email)
				?? User.Identity?.Name
				?? "Usuário";

				var isActive =
				string.Equals(User.FindFirstValue("employee_active"), "true", StringComparison.OrdinalIgnoreCase) ||
				string.Equals(User.FindFirstValue("Ativo"), "true", StringComparison.OrdinalIgnoreCase);

				<div class="d-flex align-items-center gap-2 text-white small">
					<span>Olá, <strong>@displayName</strong></span>

					@if (isAdmin)
					{
						<span class="badge rounded-pill bg-light text-dark">Admin</span>
					}
					else
					{
						<span class="badge rounded-pill bg-light text-dark">Colaborador</span>
					}

					@if (isActive)
					{
						<span class="badge rounded-pill bg-success">Ativo</span>
					}
				</div>

				<form method="post" asp-controller="Account" asp-action="Logout" class="m-0">
					@Html.AntiForgeryToken()
					<button class="btn btn-light btn-sm">Sair</button>
				</form>
			}
			else
			{
				<a class="btn btn-light btn-sm" asp-controller="Account" asp-action="Login">Entrar</a>
			}
		</div>
	</header>

	<main role="main" class="container py-4 flex-grow-1">
		@* Alerts globais *@
		@if (TempData["ok"] is string okMsg && !string.IsNullOrWhiteSpace(okMsg))
		{
			<div class="alert alert-success alert-dismissible fade show" role="alert">
				@okMsg
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		}
		@if (TempData["SuccessMessage"] is string okMsg2 && !string.IsNullOrWhiteSpace(okMsg2))
		{
			<div class="alert alert-success alert-dismissible fade show" role="alert">
				@okMsg2
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		}
		@if (TempData["error"] is string errMsg && !string.IsNullOrWhiteSpace(errMsg))
		{
			<div class="alert alert-danger alert-dismissible fade show" role="alert">
				@errMsg
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		}

		@RenderBody()
	</main>

	<footer class="mt-auto text-center">
		<small>&copy; @DateTime.Now.Year - Easy PontoApp</small>
	</footer>

	<!-- Scripts -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/4.0.0/jquery.validate.unobtrusive.min.js" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

	<script>
		// Máscaras + limpeza antes do submit
		(function () {
			var $phone = $('#Phone, input[name="Phone"]');
			var $cpf   = $('#Cpf, input[name="Cpf"]');
			var $cnpj  = $('#Cnpj, input[name="Cnpj"]');

			if ($phone.length) {
				var behavior = function (val) {
					return val.replace(/\D/g, '').length === 11 ? '(00) 00000-0000' : '(00) 0000-0000';
				};
				$phone.mask(behavior, {
					onKeyPress: function (val, e, field, options) {
						field.mask(behavior.apply({}, arguments), options);
					}
				});
			}
			if ($cpf.length)  $cpf.mask('000.000.000-00', { reverse: true });
			if ($cnpj.length) $cnpj.mask('00.000.000/0000-00', { reverse: true });

			$(document).on('submit', 'form', function () {
				if ($phone.length && $phone.cleanVal) $phone.val($phone.cleanVal());
				if ($cpf.length   && $cpf.cleanVal)   $cpf.val($cpf.cleanVal());
				if ($cnpj.length  && $cnpj.cleanVal)  $cnpj.val($cnpj.cleanVal());
			});
		})();
	</script>

	<script>
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('/service-worker.js');
		}
	</script>

	@RenderSection("Scripts", required: false)
</body>
</html>
